const DB_NAME = "flatRateLogDB";
const DB_VERSION = 1;
const STORE = "entries";

const $ = (id) => document.getElementById(id);

function nowISO() { return new Date().toISOString(); }

function todayKeyLocal() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function formatMoney(n) {
  const x = Number(n || 0);
  return `$${x.toFixed(2)}`;
}

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        const os = db.createObjectStore(STORE, { keyPath: "id" });
        os.createIndex("createdAt", "createdAt", { unique: false });
        os.createIndex("dayKey", "dayKey", { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function txStore(mode = "readonly") {
  const db = await openDB();
  const tx = db.transaction(STORE, mode);
  return { db, tx, store: tx.objectStore(STORE) };
}

async function addEntry(entry) {
  const { db, store } = await txStore("readwrite");
  await new Promise((resolve, reject) => {
    const req = store.add(entry);
    req.onsuccess = () => resolve(true);
    req.onerror = () => reject(req.error);
  });
  db.close();
}

async function getAllEntries() {
  const { db, store } = await txStore("readonly");
  const items = await new Promise((resolve, reject) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
  db.close();
  items.sort((a, b) => (b.createdAt || "").localeCompare(a.createdAt || ""));
  return items;
}

async function wipeAll() {
  const { db, store } = await txStore("readwrite");
  await new Promise((resolve, reject) => {
    const req = store.clear();
    req.onsuccess = () => resolve(true);
    req.onerror = () => reject(req.error);
  });
  db.close();
}

function uuid() {
  return crypto.randomUUID ? crypto.randomUUID() : `id_${Date.now()}_${Math.random().toString(16).slice(2)}`;
}

async function fileToDataURL(file) {
  if (!file) return null;
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(reader.error);
    reader.readAsDataURL(file);
  });
}

function computeSummary(entries, dayKey) {
  const today = entries.filter(e => e.dayKey === dayKey);
  const units = today.reduce((s, e) => s + Number(e.units || 0), 0);
  const dollars = today.reduce((s, e) => s + Number(e.earnings || 0), 0);
  return { units, dollars, count: today.length };
}

function toCSV(entries) {
  const header = ["createdAt","dayKey","ro","vin8","type","units","rate","earnings","notes","hasPhoto"];
  const escape = (v) => {
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  };
  const rows = entries.map(e => ([
    e.createdAt, e.dayKey, e.ro, e.vin8, e.type, e.units, e.rate, e.earnings, e.notes,
    e.photoDataUrl ? "yes" : "no",
  ].map(escape).join(",")));
  return [header.join(","), ...rows].join("\n");
}

function downloadText(filename, text, mime="text/plain") {
  const blob = new Blob([text], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function renderList(entries, mode) {
  const list = $("entryList");
  list.innerHTML = "";

  const dayKey = todayKeyLocal();
  const filtered = (mode === "today") ? entries.filter(e => e.dayKey === dayKey) : entries;

  if (filtered.length === 0) {
    list.innerHTML = `<div class="muted">No entries.</div>`;
    return;
  }

  for (const e of filtered.slice(0, 50)) {
    const div = document.createElement("div");
    div.className = "item";
    const money = formatMoney(e.earnings);
    const ts = new Date(e.createdAt).toLocaleString();
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div><span class="mono">RO ${e.ro}</span> <span class="muted">(${e.type})</span></div>
          <div class="muted small">VIN8: <span class="mono">${e.vin8 || "-"}</span> • ${ts}</div>
          ${e.notes ? `<div class="small" style="margin-top:6px;">${escapeHtml(e.notes)}</div>` : ""}
          ${e.photoDataUrl ? `<img alt="Proof" src="${e.photoDataUrl}" style="margin-top:10px;width:100%;max-height:240px;object-fit:cover;border-radius:12px;border:1px solid #222;" />` : ""}
        </div>
        <div class="right">
          <div class="mono">${e.units}u × ${formatMoney(e.rate)}</div>
          <div style="margin-top:6px;font-size:18px;">${money}</div>
        </div>
      </div>
    `;
    list.appendChild(div);
  }
}

async function refreshUI() {
  const entries = await getAllEntries();
  const dayKey = todayKeyLocal();
  const sum = computeSummary(entries, dayKey);

  $("todayUnits").textContent = String(sum.units);
  $("todayDollars").textContent = formatMoney(sum.dollars);
  $("todayCount").textContent = String(sum.count);

  const mode = $("filterSelect").value;
  renderList(entries, mode);
}

function registerSW() {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  }
}

document.addEventListener("DOMContentLoaded", () => {
  registerSW();

  $("filterSelect").addEventListener("change", refreshUI);
  $("refreshBtn").addEventListener("click", refreshUI);

  $("clearFormBtn").addEventListener("click", () => {
    $("logForm").reset();
    $("logForm").elements["units"].value = 1;
    $("logForm").elements["rate"].value = 15;
  });

  $("wipeBtn").addEventListener("click", async () => {
    const ok = confirm("Wipe ALL local entries on this device?");
    if (!ok) return;
    await wipeAll();
    await refreshUI();
  });

  $("exportCsvBtn").addEventListener("click", async () => {
    const entries = await getAllEntries();
    downloadText(`flat_rate_log_${todayKeyLocal()}.csv`, toCSV(entries), "text/csv");
  });

  $("exportJsonBtn").addEventListener("click", async () => {
    const entries = await getAllEntries();
    downloadText(`flat_rate_log_${todayKeyLocal()}.json`, JSON.stringify(entries, null, 2), "application/json");
  });

  $("logForm").addEventListener("submit", async (ev) => {
    ev.preventDefault();
    const fd = new FormData(ev.target);

    const ro = String(fd.get("ro") || "").trim();
    const vin8 = String(fd.get("vin8") || "").trim().toUpperCase().slice(0, 8);
    const type = String(fd.get("type") || "").trim();
    const units = Number(fd.get("units") || 0);
    const rate = Number(fd.get("rate") || 0);
    const notes = String(fd.get("notes") || "").trim();
    const photoFile = fd.get("photo");
    const photoDataUrl = (photoFile && photoFile.size) ? await fileToDataURL(photoFile) : null;

    if (!ro) return alert("RO # is required.");
    if (!Number.isFinite(units) || units <= 0) return alert("Units must be >= 1.");
    if (!Number.isFinite(rate) || rate < 0) return alert("Rate must be >= 0.");

    const createdAt = nowISO();
    const dayKey = todayKeyLocal();
    const earnings = Number((units * rate).toFixed(2));

    await addEntry({
      id: uuid(),
      createdAt,
      dayKey,
      ro,
      vin8,
      type,
      units,
      rate,
      earnings,
      notes,
      photoDataUrl
    });

    ev.target.reset();
    ev.target.elements["units"].value = 1;
    ev.target.elements["rate"].value = 15;

    await refreshUI();
  });

  refreshUI();
});
